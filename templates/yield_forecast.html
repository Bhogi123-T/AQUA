{% extends "layout.html" %}

{% block content %}
<div class="app-card">
    <span class="app-emoji">ðŸ“ˆ</span>
    <h2 style="font-size: 3rem; font-weight: 900; margin-bottom: 1rem;">{{ trans['yield_title'] | safe }}</h2>
    <p style="color: var(--text-muted); margin-bottom: 3.5rem; font-size: 1.2rem;">{{ trans['feat_yield_desc'] }}</p>

    <div
        style="background: rgba(58, 123, 213, 0.05); padding: 1.5rem; border-radius: 1.5rem; margin-bottom: 2.5rem; border: 1px dashed var(--secondary); display: flex; align-items: center; justify-content: space-between;">
        <div style="text-align: left;">
            <p style="margin:0; font-weight: 800; color: var(--secondary);">ðŸ§  LIVE GROWTH CONTEXT</p>
            <p style="margin:0; font-size: 0.8rem; color: var(--text-muted);">Current ML Prediction: <span
                    id="sync-growth-val" style="color: white; font-weight: 800;">--</span> g/day</p>
            <p id="yield-offline-notice"
                style="margin:5px 0 0 0; font-size: 0.75rem; color: #ff6b6b; font-weight: 700; display: none;">ðŸ“¡
                OFFLINE - Last cached value shown</p>
        </div>
        <div style="text-align: right;">
            <span style="font-size: 0.7rem; color: var(--text-muted); display: block; margin-bottom: 5px;">STOCK
                HEALTH</span>
            <span id="sync-health-val"
                style="background: rgba(0, 255, 136, 0.1); color: #00ff88; padding: 4px 10px; border-radius: 5px; font-weight: 800;">--</span>
        </div>
    </div>

    <form action="/predict_yield" method="POST" class="app-form">
        <div class="app-input-group">
            <span class="app-label">{{ trans['species'] }}</span>
            <select name="species" class="app-input">
                {% for spec in species_list %}
                <option value="{{ spec.id }}">{{ spec.display }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="app-input-group">
            <span class="app-label">{{ trans['pond_area'] }} ({{ trans['unit_hectares'] }})</span>
            <input type="number" step="0.01" name="area" class="app-input" placeholder="e.g. 1.2" required>
        </div>

        <div class="app-input-group">
            <span class="app-label">{{ trans['total_feed'] }} (kg)</span>
            <input type="number" name="feed" class="app-input" placeholder="e.g. 1200" required>
        </div>

        <div class="app-input-group">
            <span class="app-label">{{ trans['culture_dur'] }} ({{ trans['days'] }})</span>
            <input type="number" name="days" class="app-input" placeholder="e.g. 120" required>
        </div>

        <div class="app-input-group">
            <span class="app-label">ðŸ“Š Display Unit</span>
            <select name="unit_preference" class="app-input" id="yield-unit-pref">
                <option value="tons" selected>Metric Tons (MT)</option>
                <option value="kg">Kilograms (kg)</option>
                <option value="grams">Grams (g)</option>
                <option value="pounds">Pounds (lbs)</option>
            </select>
        </div>

        <button class="app-btn-large">ðŸ”® {{ trans['btn_yield'] }}</button>
    </form>

    <script>
        let cachedYieldData = null;

        async function fetchYieldContext() {
            try {
                // Check if offline
                if (!navigator.onLine || !window.ALLOW_LIVE_DATA) {
                    // Use cached data
                    if (cachedYieldData) {
                        document.getElementById('sync-growth-val').innerText = cachedYieldData.growth_rate;
                        document.getElementById('sync-health-val').innerText = cachedYieldData.health_index + '%';
                        document.getElementById('yield-offline-notice').style.display = 'block';
                    } else {
                        document.getElementById('sync-growth-val').innerText = '-- ðŸ“¡';
                        document.getElementById('sync-health-val').innerText = '-- ðŸ“¡';
                        document.getElementById('yield-offline-notice').style.display = 'block';
                    }
                    return;
                }

                // Hide offline notice when online
                document.getElementById('yield-offline-notice').style.display = 'none';

                const res = await fetch('/api/realtime');
                const data = await res.json();

                // Cache the data
                cachedYieldData = data;
                localStorage.setItem('cachedYieldData', JSON.stringify(data));

                document.getElementById('sync-growth-val').innerText = data.growth_rate;
                document.getElementById('sync-health-val').innerText = data.health_index + '%';
            } catch (e) {
                console.log("Yield context fetch failed", e);
                // Fallback to cached or offline state
                if (cachedYieldData) {
                    document.getElementById('sync-growth-val').innerText = cachedYieldData.growth_rate;
                    document.getElementById('sync-health-val').innerText = cachedYieldData.health_index + '%';
                    document.getElementById('yield-offline-notice').style.display = 'block';
                }
            }
        }

        // Load cached data on page load
        const savedYieldData = localStorage.getItem('cachedYieldData');
        if (savedYieldData) {
            cachedYieldData = JSON.parse(savedYieldData);
        }

        fetchYieldContext();
        setInterval(fetchYieldContext, 5000);

        // Listen for online/offline events
        window.addEventListener('online', fetchYieldContext);
        window.addEventListener('offline', fetchYieldContext);
    </script>

    <div style="margin-top: 4rem;">
        <a href="/farmer?lang={{ lang }}"
            style="color: var(--text-muted); text-decoration: none; font-weight: 800; font-size: 1.4rem; transition: color 0.3s;">
            ðŸ”™ {{ trans['back'] }}
        </a>
    </div>
</div>
{% endblock %}